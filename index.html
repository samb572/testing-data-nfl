<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QB Fantasy Projections with Matchup Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s;
        }

        .nav-tab.active {
            color: #2563eb;
            background: white;
            border-bottom: 2px solid #2563eb;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }

        .sidebar {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            height: fit-content;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .input-group select,
        .input-group input,
        .input-group input[type="file"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-group select:focus,
        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .project-btn, .audit-btn {
            width: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }
        
        .audit-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .project-btn:hover, .audit-btn:hover {
            transform: translateY(-2px);
        }
        
        .project-btn:disabled, .audit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .csv-info {
            background: #f0f9ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .results-area {
            background: white;
            border-radius: 15px;
            padding: 25px;
        }

        .projection-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #0ea5e9;
            position: relative;
        }

        .boom-matchup { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left-color: #10b981; }
        .bust-matchup { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left-color: #ef4444; }
        .neutral-matchup { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-left-color: #64748b; }

        .projection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .qb-name { font-size: 1.5rem; font-weight: 700; color: #0f172a; }
        .opponent { background: #dc2626; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; }

        .matchup-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .boom-indicator { background: #10b981; color: white; }
        .bust-indicator { background: #ef4444; color: white; }
        .neutral-indicator { background: #64748b; color: white; }

        .projection-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); }
        .stat-value { font-size: 2rem; font-weight: 700; color: #0ea5e9; margin-bottom: 5px; }
        .stat-label { font-size: 0.9rem; color: #64748b; font-weight: 500; }
        
        .coverage-analysis { background: #f0f9ff; border-radius: 12px; padding: 20px; margin-top: 20px; border: 1px solid #bfdbfe; }
        .coverage-title { font-size: 1.2rem; font-weight: 600; color: #1e3a8a; margin-bottom: 15px; }
        .coverage-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center; }
        .coverage-label { font-weight: 600; color: #374151; margin-bottom: 8px; }
        .coverage-impact-card { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); padding: 20px; border-radius: 12px; text-align: center; grid-column: 1 / -1; }
        .coverage-impact-value { font-size: 1.5rem; font-weight: 700; color: #1e40af; }

        .breakdown-section { background: #f8fafc; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .breakdown-title { font-size: 1.2rem; font-weight: 600; color: #374151; margin-bottom: 15px; }
        .breakdown-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .breakdown-item { background: white; padding: 15px; border-radius: 8px; text-align: center; }
        .breakdown-value { font-size: 1.1rem; font-weight: 600; color: #0f172a; }
        
        .loading { text-align: center; color: #64748b; font-style: italic; padding: 40px; }
        .error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 15px; border-radius: 10px; margin: 10px 0; }
        .success { background: #f0fdf4; border: 1px solid #bbf7d0; color: #059669; padding: 15px; border-radius: 10px; margin: 10px 0; }
        
        /* Audit styles */
        .audit-summary { background: linear-gradient(135deg, #fef3c7 0%, #fef3c7 100%); border-radius: 15px; padding: 20px; margin-bottom: 25px; border-left: 5px solid #f59e0b; }
        .player-audit-card { background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #10b981; }
        .player-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .player-name { font-size: 1.3rem; font-weight: 700; color: #0f172a; }
        .accuracy-score { background: #10b981; color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; }
        .weekly-breakdown { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
        .week-item { background: white; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9rem; border-left: 3px solid #e5e7eb; }
        .week-boom { border-left-color: #10b981; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); }
        .week-bust { border-left-color: #ef4444; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); }
        .week-projected { color: #059669; font-weight: 600; }
        .week-actual { color: #dc2626; font-weight: 600; }
        .week-diff { color: #6b7280; font-size: 0.8rem; }
        .progress-bar { width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #059669); transition: width 0.3s ease; }


        @media (max-width: 968px) {
            .main-content { grid-template-columns: 1fr; }
            .header h1 { font-size: 2rem; }
            .matchup-indicator { position: static; margin-bottom: 15px; align-self: flex-start; }
            .projection-header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .coverage-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèà QB Matchup Analyzer</h1>
            <p>Statistically Enhanced Projections with Confidence Intervals</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('projection')">Matchup Analysis</button>
            <button class="nav-tab" onclick="switchTab('audit')">Season Audit</button>
        </div>

        <div id="projection-tab" class="tab-content active">
            <div class="main-content">
                <div class="sidebar">
                    <div class="input-group">
                        <label for="qb-select">Select Quarterback</label>
                        <select id="qb-select">
                            <option value="">Loading QBs...</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="opponent-select">Select Opponent</label>
                        <select id="opponent-select">
                            <option value="">Loading Teams...</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="spread-input">Point Spread (+ if favored)</label>
                        <input type="number" id="spread-input" step="0.5" placeholder="e.g., -3.5">
                    </div>

                    <div class="input-group">
                        <label for="total-input">Game Total (O/U)</label>
                        <input type="number" id="total-input" step="0.5" placeholder="e.g., 47.5">
                    </div>

                    <button class="project-btn" onclick="generateProjection()">
                        Analyze Matchup
                    </button>

                    <div id="status-message"></div>
                </div>

                <div class="results-area">
                    <div id="projection-results">
                        <div class="loading">
                            Select a quarterback and opponent to analyze the matchup...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="audit-tab" class="tab-content">
            <div class="main-content">
                <div class="sidebar">
                    <div class="input-group">
                        <label for="csv-upload">Upload 2024 NFL Odds CSV</label>
                        <input type="file" id="csv-upload" accept=".csv" onchange="handleCSVUpload(event)">
                        <div class="csv-info">
                           Required columns: `home_team`, `away_team`, `commence_time`, `dk_spread_home`, `dk_spread_away`, `dk_total_point`.
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="gamelog-upload">Upload QB Game Log CSV</label>
                        <input type="file" id="gamelog-upload" accept=".csv" onchange="handleGameLogUpload(event)">
                        <div class="csv-info">
                           Required columns: `Player`, `Team`, and columns `1` through `18` for weekly fantasy points.
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="min-games">Minimum Games Played</label>
                        <input type="number" id="min-games" value="8" min="1" max="18">
                    </div>

                    <button class="audit-btn" id="audit-btn" onclick="runSeasonAudit()" disabled>
                        Run Statistical Audit
                    </button>
                    
                    <div id="audit-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                        </div>
                        <div id="progress-text">Processing...</div>
                    </div>

                    <div id="audit-status"></div>
                </div>

                <div class="results-area">
                    <div id="audit-results">
                        <div class="loading">
                            Upload both CSV files to run a full season projection audit.
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const SUPABASE_URL = 'https://ooxzkffzedtfiiparnrz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9veHprZmZ6ZWR0ZmlpcGFybnJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5Mzk5NzgsImV4cCI6MjA2NzUxNTk3OH0.exRTwGBwMWC-fpZvySHnxBEOpPpytHzKRO_s5FlnMhA';
        
        let supabaseClient;
        let qbData = [];
        let defenseData = [];
        let csvData = [];
        let gameLogData = {};

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const { createClient } = supabase;
                supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('üöÄ Application loaded successfully');
                await Promise.all([loadQBData(), loadDefenseData()]);
            } catch (error) {
                console.error('‚ùå Failed to initialize:', error);
                showStatus('Failed to initialize database connection', 'error', 'status-message');
            }
        });

        class EnhancedQBMatchupAnalyzer {
             constructor() {
                this.gameScriptAdjustments = {
                    spread: { bigFavorite: 0.90, favorite: 0.95, smallFavorite: 0.98, pickEm: 1.0, smallUnderdog: 1.02, underdog: 1.06, bigUnderdog: 1.12 },
                    total: { veryLow: 0.90, low: 0.95, average: 1.0, high: 1.05, veryHigh: 1.10 }
                };
             }

            calculateCoverageImpact(qb, opponentDefense) {
                if (!opponentDefense) {
                    return { multiplier: 1.0, breakdown: null };
                }

                const baseFpdb = qb.weighted_fp_per_db || 0.43;
                const qbVsMan = qb.man_fp_db ?? baseFpdb;
                const qbVsZone = qb.zone_fp_db ?? baseFpdb;
                const qbVsBlitz = ((qbVsMan + qbVsZone) / 2) * 1.05;

                const manRate = (opponentDefense.man_coverage_rate || 30) / 100;
                const zoneRate = (opponentDefense.zone_coverage_rate || 60) / 100;
                const blitzRate = (opponentDefense.blitz_rate || 10) / 100;

                const totalRate = manRate + zoneRate + blitzRate;
                const normManRate = totalRate > 0 ? manRate / totalRate : 0.33;
                const normZoneRate = totalRate > 0 ? zoneRate / totalRate : 0.34;
                const normBlitzRate = totalRate > 0 ? blitzRate / totalRate : 0.33;

                const expectedFpdb = (qbVsMan * normManRate) + (qbVsZone * normZoneRate) + (qbVsBlitz * normBlitzRate);
                const multiplier = baseFpdb > 0 ? expectedFpdb / baseFpdb : 1.0;

                return {
                    multiplier: multiplier,
                    breakdown: {
                        man: { rate: manRate * 100, qbFpdb: qbVsMan },
                        zone: { rate: zoneRate * 100, qbFpdb: qbVsZone },
                        blitz: { rate: blitzRate * 100, qbFpdb: qbVsBlitz },
                        expectedFpdb: expectedFpdb
                    }
                };
            }

            calculateProjection(qb, gameContext, opponentDefense = null) {
                try {
                    let baseFPPerDB = qb.weighted_fp_per_db || 0.4;
                    const estimatedDropbacks = qb.total_dropbacks ? Math.round(qb.total_dropbacks / 17) : 35;
                    
                    let gameScriptMultiplier = 1.0;
                    if (gameContext.spread !== null) gameScriptMultiplier *= this.getSpreadMultiplier(gameContext.spread);
                    if (gameContext.total !== null) gameScriptMultiplier *= this.getTotalMultiplier(gameContext.total);

                    const { multiplier: coverageImpactMultiplier, breakdown: coverageBreakdown } = this.calculateCoverageImpact(qb, opponentDefense);
                    const totalMultiplier = gameScriptMultiplier * coverageImpactMultiplier;
                    const adjustedFPPerDB = baseFPPerDB * totalMultiplier;
                    const totalProjectedFP = adjustedFPPerDB * estimatedDropbacks;

                    let matchupType = 'neutral';
                    if (coverageImpactMultiplier > 1.07) matchupType = 'boom';
                    if (coverageImpactMultiplier < 0.93) matchupType = 'bust';

                    return {
                        totalProjectedFP, adjustedFPPerDB, estimatedDropbacks, matchupType,
                        coverageImpact: { multiplier: coverageImpactMultiplier, breakdown: coverageBreakdown },
                        adjustmentBreakdown: {
                            spreadAdj: gameContext.spread !== null ? this.getSpreadMultiplier(gameContext.spread) : 1.0,
                            totalAdj: gameContext.total !== null ? this.getTotalMultiplier(gameContext.total) : 1.0,
                            defenseAdj: coverageImpactMultiplier
                        }
                    };
                } catch (error) {
                    console.error('‚ùå Projection calculation error:', error);
                    return null;
                }
            }

            getSpreadMultiplier(spread) { const s = this.gameScriptAdjustments.spread; if (spread <= -14) return s.bigFavorite; if (spread <= -7) return s.favorite; if (spread <= -3) return s.smallFavorite; if (spread <= 2.5) return s.pickEm; if (spread <= 6.5) return s.smallUnderdog; if (spread <= 13.5) return s.underdog; return s.bigUnderdog; }
            getTotalMultiplier(total) { const t = this.gameScriptAdjustments.total; if (total < 40) return t.veryLow; if (total < 45) return t.low; if (total < 50) return t.average; if (total < 55) return t.high; return t.veryHigh; }
        }

        const projector = new EnhancedQBMatchupAnalyzer();

        // --- DATA LOADING ---
        async function loadQBData() { /* ... unchanged ... */ }
        async function loadDefenseData() { /* ... unchanged ... */ }
        
        // --- UI POPULATION ---
        function populateQBSelect() { /* ... unchanged ... */ }
        function populateOpponentSelect() { /* ... unchanged ... */ }
        
        // --- UI INTERACTION ---
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function generateProjection() {
            const qbId = document.getElementById('qb-select').value;
            const opponentTeam = document.getElementById('opponent-select').value;

            if (!qbId || !opponentTeam) {
                showStatus('Please select a QB and Opponent', 'error', 'status-message');
                return;
            }

            const selectedQB = qbData.find(qb => qb.player_id == qbId);
            const opponentDefense = defenseData.find(def => def.team === opponentTeam);
            const gameContext = {
                spread: parseFloat(document.getElementById('spread-input').value) || null,
                total: parseFloat(document.getElementById('total-input').value) || null
            };

            const projection = projector.calculateProjection(selectedQB, gameContext, opponentDefense);
            
            if (projection) {
                displayProjection(selectedQB, projection, opponentDefense);
                showStatus(`Analysis complete!`, 'success', 'status-message');
            } else {
                showStatus('Failed to generate projection', 'error', 'status-message');
            }
        }
        
        // --- DISPLAY LOGIC ---
        function renderCoverageAnalysis(projection) {
             if (!projection.coverageImpact.breakdown) {
                return `<div class="coverage-analysis"><div class="coverage-title">üõ°Ô∏è Coverage Matchup</div><div>No defensive data available.</div></div>`;
            }

            const breakdown = projection.coverageImpact.breakdown;
            const impactMultiplier = projection.coverageImpact.multiplier;
            const impactColor = impactMultiplier >= 1 ? '#10b981' : '#ef4444';
            const impactSymbol = impactMultiplier >= 1 ? '‚ñ≤' : '‚ñº';
            
            return `<div class="coverage-analysis">
                    <div class="coverage-title">üõ°Ô∏è Coverage-Based Matchup</div>
                    <div class="coverage-grid">
                        <div><div class="coverage-label">${breakdown.man.rate.toFixed(1)}% Man Rate</div><div class="coverage-label">${breakdown.zone.rate.toFixed(1)}% Zone Rate</div></div>
                        <div><div class="coverage-label">${breakdown.man.qbFpdb.toFixed(3)} FP/DB vs Man</div><div class="coverage-label">${breakdown.zone.qbFpdb.toFixed(3)} FP/DB vs Zone</div></div>
                        <div class="coverage-impact-card">
                            <div class="coverage-label">Matchup-Adjusted FP/DB</div>
                            <div class="coverage-impact-value" style="color: ${impactColor};">${breakdown.expectedFpdb.toFixed(3)}
                                <span style="font-size: 1rem;">(${impactSymbol} ${(Math.abs(1 - impactMultiplier) * 100).toFixed(1)}%)</span>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function displayProjection(qb, projection, opponentDefense) {
            const resultsDiv = document.getElementById('projection-results');
            const opponentName = opponentDefense ? (opponentDefense.team_name || opponentDefense.team) : document.getElementById('opponent-select').value;
            
            let cardClass = 'projection-card ' + projection.matchupType + '-matchup';
            let indicatorClass = 'matchup-indicator ' + projection.matchupType + '-indicator';
            let indicatorText = projection.matchupType.toUpperCase() + ' MATCHUP';
            let indicatorIcon = projection.matchupType === 'boom' ? 'üöÄ' : (projection.matchupType === 'bust' ? '‚ö†Ô∏è' : '‚öñÔ∏è');
            
            const coverageHTML = renderCoverageAnalysis(projection);

            resultsDiv.innerHTML = `<div class="${cardClass}">
                    <div class="${indicatorClass}">${indicatorIcon} ${indicatorText}</div>
                    <div class="projection-header"><span class="qb-name">${qb.players.name} (${qb.players.team})</span><span class="opponent">vs ${opponentName}</span></div>
                    <div class="projection-stats">
                        <div class="stat-card"><div class="stat-value">${projection.totalProjectedFP.toFixed(1)}</div><div class="stat-label">Projected FP</div></div>
                        <div class="stat-card"><div class="stat-value">${projection.adjustedFPPerDB.toFixed(3)}</div><div class="stat-label">Final FP/Dropback</div></div>
                        <div class="stat-card"><div class="stat-value">${projection.estimatedDropbacks}</div><div class="stat-label">Projected Dropbacks</div></div>
                    </div>
                    ${coverageHTML}
                    <div class="breakdown-section"><div class="breakdown-title">‚öôÔ∏è Projection Modifiers</div>
                        <div class="breakdown-grid">
                             <div class="breakdown-item"><div class="breakdown-value">${((projection.adjustmentBreakdown.spreadAdj - 1) * 100).toFixed(1)}%</div><div class="breakdown-label">Spread Impact</div></div>
                             <div class="breakdown-item"><div class="breakdown-value">${((projection.adjustmentBreakdown.totalAdj - 1) * 100).toFixed(1)}%</div><div class="breakdown-label">Total Impact</div></div>
                             <div class="breakdown-item"><div class="breakdown-value" style="color: ${projection.adjustmentBreakdown.defenseAdj >= 1 ? '#10b981' : '#ef4444'};">${((projection.adjustmentBreakdown.defenseAdj - 1) * 100).toFixed(1)}%</div><div class="breakdown-label">Coverage Impact</div></div>
                        </div>
                    </div>
                </div>`;
        }

        // --- AUDIT FUNCTIONALITY ---

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showStatus('Parsing odds CSV...', 'loading', 'audit-status');
            Papa.parse(file, {
                header: true,
                complete: (results) => {
                    csvData = results.data.filter(row => row.home_team && row.away_team);
                    console.log(`‚úÖ Odds CSV loaded with ${csvData.length} games.`);
                    showStatus(`‚úÖ Odds CSV loaded: ${csvData.length} games found.`, 'success', 'audit-status');
                    checkAuditButtonStatus();
                },
                error: (error) => {
                    console.error('‚ùå Odds CSV parsing error:', error);
                    showStatus('Error parsing Odds CSV file.', 'error', 'audit-status');
                }
            });
        }
        
        function handleGameLogUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            showStatus('Parsing game log CSV...', 'loading', 'audit-status');
             Papa.parse(file, {
                header: true,
                complete: (results) => {
                    gameLogData = processGameLogData(results.data);
                    const playerCount = Object.keys(gameLogData).length;
                    console.log(`‚úÖ Game Log CSV loaded for ${playerCount} players.`);
                    showStatus(`‚úÖ Game Log CSV loaded: ${playerCount} players found.`, 'success', 'audit-status');
                    checkAuditButtonStatus();
                },
                error: (error) => {
                    console.error('‚ùå Game Log CSV parsing error:', error);
                    showStatus('Error parsing Game Log CSV file.', 'error', 'audit-status');
                }
            });
        }

        function processGameLogData(rawData) {
            const processed = {};
            rawData.forEach(row => {
                if (!row.Player || !row.Team) return;
                const playerName = row.Player.trim();
                if (processed[playerName]) return;

                const weeklyScores = [];
                for (let week = 1; week <= 18; week++) {
                    const score = parseFloat(row[week.toString()]);
                    if (!isNaN(score)) {
                        weeklyScores.push({ week: week, points: score });
                    }
                }
                if (weeklyScores.length > 0) {
                    processed[playerName] = { team: row.Team.trim(), weeklyScores: weeklyScores };
                }
            });
            return processed;
        }

        function checkAuditButtonStatus() {
            const auditBtn = document.getElementById('audit-btn');
            auditBtn.disabled = !(csvData.length > 0 && Object.keys(gameLogData).length > 0 && qbData.length > 0);
        }

        const teamMapping = { 'Kansas City Chiefs': 'KC', 'Baltimore Ravens': 'BAL', 'Philadelphia Eagles': 'PHI', 'Green Bay Packers': 'GB', 'Buffalo Bills': 'BUF', 'Arizona Cardinals': 'ARI', 'Atlanta Falcons': 'ATL', 'Pittsburgh Steelers': 'PIT', 'New Orleans Saints': 'NO', 'Carolina Panthers': 'CAR', 'Chicago Bears': 'CHI', 'Tennessee Titans': 'TEN', 'Cincinnati Bengals': 'CIN', 'New England Patriots': 'NE', 'Indianapolis Colts': 'IND', 'Houston Texans': 'HOU', 'Miami Dolphins': 'MIA', 'Jacksonville Jaguars': 'JAX', 'New York Giants': 'NYG', 'Minnesota Vikings': 'MIN', 'Seattle Seahawks': 'SEA', 'Denver Broncos': 'DEN', 'Los Angeles Chargers': 'LAC', 'Las Vegas Raiders': 'LV', 'Cleveland Browns': 'CLE', 'Dallas Cowboys': 'DAL', 'Tampa Bay Buccaneers': 'TB', 'Washington Commanders': 'WAS', 'Los Angeles Rams': 'LAR', 'San Francisco 49ers': 'SF', 'Detroit Lions': 'DET', 'New York Jets': 'NYJ' };
        function normalizeTeamName(teamName) { return teamMapping[teamName] || teamName; }

        function getWeekFromDate(dateString) {
            const gameDate = new Date(dateString);
            const seasonStart = new Date('2024-09-04'); // Wednesday before first Thursday game
            const daysDiff = Math.floor((gameDate - seasonStart) / (1000 * 60 * 60 * 24));
            return Math.floor(daysDiff / 7) + 1;
        }

        function getActualFantasyPoints(playerName, week) {
            const playerData = gameLogData[playerName];
            if (!playerData) return null;
            const weekData = playerData.weeklyScores.find(w => w.week === week);
            return weekData ? weekData.points : null;
        }

        async function runSeasonAudit() {
            if (csvData.length === 0 || Object.keys(gameLogData).length === 0) {
                showStatus('Please upload both CSV files.', 'error', 'audit-status');
                return;
            }

            const minGames = parseInt(document.getElementById('min-games').value) || 8;
            document.getElementById('audit-progress').style.display = 'block';
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            showStatus(`Starting audit for QBs with at least ${minGames} games...`, 'loading', 'audit-status');
            
            let auditResults = [];
            const eligibleQBs = qbData; // All loaded QBs are potentially eligible

            for (let i = 0; i < eligibleQBs.length; i++) {
                const qb = eligibleQBs[i];
                const progress = ((i + 1) / eligibleQBs.length) * 100;
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `Processing ${qb.players.name} (${i + 1}/${eligibleQBs.length})`;

                const qbGames = csvData.filter(game => {
                    const homeTeam = normalizeTeamName(game.home_team);
                    const awayTeam = normalizeTeamName(game.away_team);
                    return homeTeam === qb.players.team || awayTeam === qb.players.team;
                });
                
                let weeklyResults = [];
                let totalSquaredError = 0;

                for (const game of qbGames) {
                    try {
                        const homeTeam = normalizeTeamName(game.home_team);
                        const awayTeam = normalizeTeamName(game.away_team);
                        const isHome = homeTeam === qb.players.team;
                        const opponent = isHome ? awayTeam : homeTeam;
                        
                        const opponentDefense = defenseData.find(def => def.team === opponent);
                        const spread = isHome ? parseFloat(game.dk_spread_home) : parseFloat(game.dk_spread_away);
                        const total = parseFloat(game.dk_total_point);
                        const week = getWeekFromDate(game.commence_time);
                        
                        const gameContext = {
                            spread: isNaN(spread) ? null : spread,
                            total: isNaN(total) ? null : total
                        };
                        
                        const projection = projector.calculateProjection(qb, gameContext, opponentDefense);
                        if (!projection) continue;
                        
                        const actualFP = getActualFantasyPoints(qb.players.name, week);
                        if (actualFP === null) continue;

                        const error = actualFP - projection.totalProjectedFP;
                        totalSquaredError += error * error;
                        
                        weeklyResults.push({
                            week: week,
                            opponent: opponent,
                            projected: projection.totalProjectedFP,
                            actual: actualFP,
                            diff: error,
                            matchupType: projection.matchupType,
                            wasBoomWeek: actualFP >= 25,
                            wasBustWeek: actualFP < 15,
                        });

                    } catch (e) { console.error(`Error processing game for ${qb.players.name}:`, e); }
                }

                if (weeklyResults.length >= minGames) {
                    const mae = weeklyResults.reduce((sum, r) => sum + Math.abs(r.diff), 0) / weeklyResults.length;
                    const rmse = Math.sqrt(totalSquaredError / weeklyResults.length);
                    const totalProjected = weeklyResults.reduce((sum, r) => sum + r.projected, 0);
                    const totalActual = weeklyResults.reduce((sum, r) => sum + r.actual, 0);

                    const boomMatchups = weeklyResults.filter(r => r.matchupType === 'boom').length;
                    const bustMatchups = weeklyResults.filter(r => r.matchupType === 'bust').length;
                    const boomHits = weeklyResults.filter(r => r.matchupType === 'boom' && r.wasBoomWeek).length;
                    const bustHits = weeklyResults.filter(r => r.matchupType === 'bust' && r.wasBustWeek).length;
                    
                    auditResults.push({
                        name: qb.players.name,
                        team: qb.players.team,
                        gamesPlayed: weeklyResults.length,
                        totalProjected, totalActual,
                        mae, rmse,
                        boomAccuracy: boomMatchups > 0 ? boomHits / boomMatchups : 0,
                        bustAccuracy: bustMatchups > 0 ? bustHits / bustMatchups : 0,
                        weeklyResults: weeklyResults.sort((a, b) => a.week - b.week)
                    });
                }
                await new Promise(resolve => setTimeout(resolve, 5)); // Prevent UI freeze
            }
            
            document.getElementById('audit-progress').style.display = 'none';
            auditResults.sort((a, b) => b.totalProjected - a.totalProjected);
            displayEnhancedAuditResults(auditResults);
        }

        function displayEnhancedAuditResults(results) {
            const resultsDiv = document.getElementById('audit-results');
            if (results.length === 0) {
                resultsDiv.innerHTML = `<div class="loading">No quarterbacks met the minimum game criteria of ${document.getElementById('min-games').value}.</div>`;
                return;
            }

            const avgMae = results.reduce((sum, qb) => sum + qb.mae, 0) / results.length;
            const avgRmse = results.reduce((sum, qb) => sum + qb.rmse, 0) / results.length;
            
            let html = `<div class="audit-summary"><h2>üìä 2024 Season Statistical Audit</h2>
                <div class="breakdown-grid" style="margin-top: 20px;">
                    <div class="breakdown-item"><div class="breakdown-value">${results.length}</div><div class="breakdown-label">QBs Analyzed</div></div>
                    <div class="breakdown-item"><div class="breakdown-value">${avgMae.toFixed(2)}</div><div class="breakdown-label">Avg MAE</div></div>
                    <div class="breakdown-item"><div class="breakdown-value">${avgRmse.toFixed(2)}</div><div class="breakdown-label">Avg RMSE</div></div>
                </div></div>`;

            results.forEach(qb => {
                html += `<div class="player-audit-card">
                    <div class="player-header">
                      <div class="player-name">${qb.name} (${qb.team})</div>
                      <div class="accuracy-score" style="background-color: #64748b;">${qb.gamesPlayed} Games</div>
                    </div>
                    <div class="breakdown-grid" style="margin-bottom: 15px;">
                        <div class="breakdown-item"><div class="breakdown-value">${qb.totalProjected.toFixed(1)}</div><div class="breakdown-label">Total Projected</div></div>
                        <div class="breakdown-item"><div class="breakdown-value">${qb.totalActual.toFixed(1)}</div><div class="breakdown-label">Total Actual</div></div>
                        <div class="breakdown-item"><div class="breakdown-value" style="color:${(qb.totalActual - qb.totalProjected) > 0 ? '#10b981':'#ef4444'}">${(qb.totalActual - qb.totalProjected).toFixed(1)}</div><div class="breakdown-label">Total Diff</div></div>
                        <div class="breakdown-item"><div class="breakdown-value">${qb.mae.toFixed(2)}</div><div class="breakdown-label">MAE</div></div>
                    </div>
                    <h4 style="margin-bottom: 10px;">Weekly Breakdown:</h4>
                    <div class="weekly-breakdown">${qb.weeklyResults.map(week => {
                        const diffColor = week.diff >= 0 ? '#10b981' : '#dc2626';
                        let weekClass = 'week-item';
                        if (week.matchupType === 'boom') weekClass += ' week-boom';
                        if (week.matchupType === 'bust') weekClass += ' week-bust';
                        
                        return `<div class="${weekClass}">
                                <div style="font-weight: 600;">Week ${week.week} vs ${week.opponent}</div>
                                <div class="week-projected">P: ${week.projected.toFixed(1)}</div>
                                <div class="week-actual">A: ${week.actual.toFixed(1)}</div>
                                <div class="week-diff" style="color: ${diffColor};">${week.diff >= 0 ? '+' : ''}${week.diff.toFixed(1)}</div>
                            </div>`;
                    }).join('')}</div>
                </div>`;
            });
            resultsDiv.innerHTML = html;
            showStatus(`‚úÖ Audit complete! Analyzed ${results.length} QBs.`, 'success', 'audit-status');
        }

        // --- UTILITY ---
        function showStatus(message, type, elementId) {
            const statusDiv = document.getElementById(elementId);
            if (!statusDiv) return;
            statusDiv.className = type; // Simple class for color
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
            }
        }
        
        // --- Re-add functions that were previously removed for brevity ---
        async function loadQBData() {
            try {
                console.log('üìà Loading QB data from player_summary...');
                const { data, error } = await supabaseClient
                    .from('player_summary')
                    .select('*, players(name, team)')
                    .not('players', 'is', null)
                    .gt('weighted_fp_per_db', 0.1)
                    .order('weighted_fp_per_db', { ascending: false })
                    .limit(50);

                if (error) throw error;
                if (!data || data.length === 0) throw new Error('No quarterback summary data found');

                qbData = data;
                console.log(`‚úÖ Loaded ${qbData.length} quarterbacks`);
                populateQBSelect();
                showStatus('Quarterback data loaded!', 'success', 'status-message');
            } catch (error) {
                console.error('‚ùå Error loading QB data:', error);
                showStatus(`Failed to load QB data: ${error.message}`, 'error', 'status-message');
                document.getElementById('qb-select').innerHTML = '<option value="">Failed to load QBs</option>';
            }
        }

        async function loadDefenseData() {
            try {
                console.log('üõ°Ô∏è Loading defense data...');
                const { data, error } = await supabaseClient
                    .from('opponent_defense_tendencies')
                    .select('*')
                    .order('team_name', { ascending: true });

                if (error) throw error;
                defenseData = data;
                console.log(`‚úÖ Loaded ${defenseData.length} team defenses`);
                populateOpponentSelect();
            } catch (error) {
                console.error('‚ùå Error loading defense data:', error);
                populateOpponentSelect(); // Populate with fallbacks even on error
            }
        }
        
        function populateQBSelect() {
            const select = document.getElementById('qb-select');
            select.innerHTML = '<option value="">Select a quarterback</option>';
            qbData.forEach((qb) => {
                if (!qb.players) return; // Safeguard for bad data
                const option = document.createElement('option');
                option.value = qb.player_id;
                option.textContent = `${qb.players.name} (${qb.players.team}) - ${qb.weighted_fp_per_db.toFixed(3)} FP/DB`;
                select.appendChild(option);
            });
        }
        
        function populateOpponentSelect() {
             const select = document.getElementById('opponent-select');
            select.innerHTML = '<option value="">Select opponent</option>';
            const teams = defenseData.length > 0 ? defenseData : [
                { team: 'ARI', team_name: 'Arizona Cardinals' }, { team: 'ATL', team_name: 'Atlanta Falcons' }, { team: 'BAL', team_name: 'Baltimore Ravens' }, { team: 'BUF', team_name: 'Buffalo Bills' }, { team: 'CAR', team_name: 'Carolina Panthers' }, { team: 'CHI', team_name: 'Chicago Bears' }, { team: 'CIN', team_name: 'Cincinnati Bengals' }, { team: 'CLE', team_name: 'Cleveland Browns' }, { team: 'DAL', team_name: 'Dallas Cowboys' }, { team: 'DEN', team_name: 'Denver Broncos' }, { team: 'DET', team_name: 'Detroit Lions' }, { team: 'GB', team_name: 'Green Bay Packers' }, { team: 'HOU', team_name: 'Houston Texans' }, { team: 'IND', team_name: 'Indianapolis Colts' }, { team: 'JAX', team_name: 'Jacksonville Jaguars' }, { team: 'KC', team_name: 'Kansas City Chiefs' }, { team: 'LV', team_name: 'Las Vegas Raiders' }, { team: 'LAC', team_name: 'Los Angeles Chargers' }, { team: 'LAR', team_name: 'Los Angeles Rams' }, { team: 'MIA', team_name: 'Miami Dolphins' }, { team: 'MIN', team_name: 'Minnesota Vikings' }, { team: 'NE', team_name: 'New England Patriots' }, { team: 'NO', team_name: 'New Orleans Saints' }, { team: 'NYG', team_name: 'New York Giants' }, { team: 'NYJ', team_name: 'New York Jets' }, { team: 'PHI', team_name: 'Philadelphia Eagles' }, { team: 'PIT', team_name: 'Pittsburgh Steelers' }, { team: 'SF', team_name: 'San Francisco 49ers' }, { team: 'SEA', team_name: 'Seattle Seahawks' }, { team: 'TB', team_name: 'Tampa Bay Buccaneers' }, { team: 'TEN', team_name: 'Tennessee Titans' }, { team: 'WAS', team_name: 'Washington Commanders' },
            ];
            
            teams.sort((a,b) => (a.team_name || a.team).localeCompare(b.team_name || b.team)).forEach((team) => {
                const option = document.createElement('option');
                option.value = team.team;
                option.textContent = `${team.team_name || team.team} (${team.team})`;
                select.appendChild(option);
            });
        }

    </script>
</body>
</html>
